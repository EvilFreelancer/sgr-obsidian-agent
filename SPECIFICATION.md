# Спецификация плагина SGR Obsidian Agent

## Обзор

Плагин **SGR Obsidian Agent** - это AI-ассистент для Obsidian, работающий с LLM через OpenAI-совместимый API в формате агента. Плагин предоставляет боковую панель с чатом, аналогичную реализациям в VS Code и Cursor.

## Основные требования

### 1. Архитектура плагина

#### 1.1 Структура проекта
```
sgr-obsidian-agent/
├── manifest.json          # Метаданные плагина
├── package.json          # Зависимости и скрипты
├── tsconfig.json         # Конфигурация TypeScript
├── esbuild.config.mjs    # Конфигурация сборки
├── src/
│   ├── main.ts           # Точка входа плагина
│   ├── constants.ts      # Константы и типы
│   ├── components/       # React компоненты
│   │   ├── AgentView.tsx # Основной вид боковой панели
│   │   ├── Chat.tsx      # Компонент чата
│   │   ├── ChatInput.tsx # Поле ввода сообщений
│   │   ├── ChatMessages.tsx # Отображение сообщений
│   │   ├── ChatControls.tsx # Управление чатом
│   │   ├── ModelSelector.tsx # Селектор моделей
│   │   ├── ChatHistory.tsx # История чатов
│   │   └── ui/           # UI компоненты (кнопки, селекторы и т.д.)
│   ├── settings/         # Настройки плагина
│   │   ├── model.ts      # Модель настроек
│   │   └── SettingsTab.tsx # Вкладка настроек
│   ├── core/             # Основная логика
│   │   ├── ChatManager.ts # Управление чатом
│   │   ├── MessageRepository.ts # Репозиторий сообщений
│   │   └── LLMClient.ts   # Клиент для работы с LLM API
│   ├── utils/            # Утилиты
│   └── types/            # TypeScript типы
└── styles.css            # Стили плагина
```

#### 1.2 Технологический стек
- **TypeScript** - основной язык разработки
- **React** - для UI компонентов
- **Obsidian API** - для интеграции с Obsidian
- **esbuild** - для сборки
- **Tailwind CSS** (опционально) - для стилизации

### 2. Функциональные требования

#### 2.1 Боковая панель чата

**Требования:**
- Боковая панель открывается справа по нажатию на кнопку с иконкой чата
- Иконка должна быть доступна в интерфейсе Obsidian (ribbon icon)
- Панель должна быть зарегистрирована как кастомный view через `registerView()`
- View type: `"sgr-agent-chat-view"`

**Реализация:**
```typescript
// В main.ts
this.registerView(VIEW_TYPE, (leaf: WorkspaceLeaf) => new AgentView(leaf, this));
this.addRibbonIcon("message-square", "Open SGR Agent", () => this.activateView());
```

#### 2.2 Настройки плагина

**Обязательные настройки:**
- `baseUrl` (string) - базовый URL для OpenAI-совместимого API
- `apiKey` (string) - API ключ для аутентификации
- `proxy` (string, опционально) - URL прокси-сервера

**Дополнительные настройки:**
- `defaultModel` (string) - модель по умолчанию
- `temperature` (number) - температура модели (0-2)
- `maxTokens` (number) - максимальное количество токенов
- `chatHistoryFolder` (string) - папка для сохранения истории чатов

**Интерфейс настроек:**
```typescript
interface AgentSettings {
  baseUrl: string;
  apiKey: string;
  proxy?: string;
  defaultModel: string;
  temperature: number;
  maxTokens: number;
  chatHistoryFolder: string;
}
```

**UI настроек:**
- Вкладка настроек должна быть доступна через `addSettingTab()`
- Поля для ввода: baseUrl, apiKey, proxy
- Валидация обязательных полей
- Шифрование API ключа (опционально)

#### 2.3 Подключение файлов через @

**Требования:**
- При вводе символа `@` в поле ввода должен появляться автокомплит
- Автокомплит должен показывать файлы из vault
- При выборе файла он должен быть добавлен в контекст чата
- Файлы должны отображаться как "пилюли" (pills) в поле ввода
- Поддерживаемые форматы: `.md`, `.txt` (можно расширить)

**Реализация:**
- Использовать Lexical editor (как в obsidian-copilot) или простой textarea с автокомплитом
- Парсинг упоминаний через регулярные выражения: `@\[\[filename\]\]` или `@filename`
- Хранение списка подключенных файлов в состоянии компонента
- Передача файлов в контекст при отправке сообщения

**Пример использования:**
```
Пользователь вводит: "Проанализируй @[[my-note.md]] и @[[another-file.md]]"
Результат: два файла добавляются в контекст сообщения
```

#### 2.4 Режимы общения

**Три режима:**
1. **Agent** - режим агента с автономным выполнением задач
2. **Ask** - простой режим вопрос-ответ
3. **Plan** - режим планирования с пошаговым выполнением

**Реализация:**
- Переключатель режимов в UI (кнопки или dropdown)
- Разные system prompts для каждого режима
- Различная обработка ответов в зависимости от режима

**System Prompts:**

**Agent:**
```
You are an autonomous AI agent. You can use tools to accomplish tasks.
Think step by step and decide which actions to take.
```

**Ask:**
```
You are a helpful assistant. Answer questions directly and concisely.
```

**Plan:**
```
You are a planning assistant. Break down tasks into steps and execute them systematically.
```

#### 2.5 Селектор моделей

**Требования:**
- Загрузка списка моделей через запрос к `/models` endpoint
- Отображение списка моделей в dropdown/select
- Кэширование списка моделей
- Обновление списка по кнопке или автоматически при изменении baseUrl

**Реализация:**
```typescript
async function fetchModels(baseUrl: string, apiKey: string): Promise<Model[]> {
  const response = await fetch(`${baseUrl}/models`, {
    headers: {
      'Authorization': `Bearer ${apiKey}`,
      'Content-Type': 'application/json'
    }
  });
  const data = await response.json();
  return data.data || [];
}
```

**UI:**
- Dropdown с поиском по моделям
- Отображение названия модели и провайдера (если доступно)
- Индикатор загрузки при получении списка

#### 2.6 История чатов

**Требования:**
- Сохранение истории чатов в markdown файлы
- Кнопка для открытия истории чатов
- Список предыдущих сессий с датой и временем
- Возможность загрузить предыдущую сессию
- Возможность удалить сессию
- Автосохранение текущего чата (опционально)

**Формат сохранения:**
- Markdown файлы в папке `chatHistoryFolder`
- Frontmatter с метаданными:
  ```yaml
  ---
  title: "Chat Title"
  createdAt: "2024-01-01T12:00:00Z"
  lastAccessedAt: "2024-01-01T12:00:00Z"
  model: "gpt-4"
  mode: "agent"
  ---
  ```
- Тело файла содержит историю сообщений в формате:
  ```markdown
  ## User
  Message text

  ## Assistant
  Response text
  ```

**UI истории:**
- Popover или модальное окно со списком чатов
- Сортировка по дате (новые сверху)
- Поиск по названию чата
- Кнопки: "Загрузить", "Удалить", "Открыть файл"

### 3. Технические детали

#### 3.1 Интеграция с LLM API

**OpenAI-совместимый формат:**
```typescript
interface ChatMessage {
  role: 'user' | 'assistant' | 'system';
  content: string;
}

interface ChatRequest {
  model: string;
  messages: ChatMessage[];
  temperature?: number;
  max_tokens?: number;
  stream?: boolean;
}
```

**Streaming ответов:**
- Поддержка Server-Sent Events (SSE) для потоковой передачи
- Обновление UI в реальном времени по мере получения токенов

**Обработка ошибок:**
- Валидация API ключа
- Обработка сетевых ошибок
- Обработка ошибок API (rate limits, invalid model и т.д.)
- Понятные сообщения об ошибках для пользователя

#### 3.2 Управление состоянием

**Использование React hooks:**
- `useState` для локального состояния компонентов
- `useEffect` для побочных эффектов
- `useContext` для глобального состояния (опционально)

**Хранение настроек:**
- Использование `loadData()` и `saveData()` из Obsidian API
- Атомарное обновление настроек через `setSettings()`

#### 3.3 Контекст файлов

**Обработка подключенных файлов:**
```typescript
interface FileContext {
  path: string;
  content: string;
  metadata?: {
    title?: string;
    tags?: string[];
  };
}
```

**Добавление контекста в промпт:**
- Файлы добавляются в system message или как отдельные сообщения
- Формат: `[File: filename.md]\n{content}\n[/File]`

### 4. UI/UX требования

#### 4.1 Дизайн интерфейса
- Минималистичный дизайн в стиле Obsidian
- Адаптивность под темную/светлую тему
- Плавные анимации и переходы
- Индикаторы загрузки для долгих операций

#### 4.2 Компоненты интерфейса

**Боковая панель:**
- Заголовок с названием плагина
- Кнопки режимов (Agent, Ask, Plan)
- Селектор моделей
- Кнопка истории чатов
- Область сообщений (scrollable)
- Поле ввода с поддержкой @ упоминаний
- Кнопка отправки

**Сообщения:**
- Разделение сообщений пользователя и ассистента
- Markdown рендеринг для ответов
- Подсветка кода (если есть)
- Копирование сообщений
- Редактирование своих сообщений

### 5. Сравнение с obsidian-copilot

**Сходства:**
- Использование React для UI
- Боковая панель как кастомный view
- Система настроек с API ключами
- Поддержка упоминаний файлов
- История чатов в markdown файлах
- Селектор моделей

**Отличия:**
- Упрощенная архитектура (без сложных chain runners)
- Фокус на OpenAI-совместимом API
- Три четких режима вместо множества chain types
- Более простая система контекста (только файлы через @)
- Нет поддержки проектов и сложных инструментов

### 6. Этапы разработки

#### Этап 1: Базовая структура
- [ ] Создание структуры проекта
- [ ] Настройка сборки (esbuild, TypeScript)
- [ ] Базовый main.ts с регистрацией плагина
- [ ] Простая боковая панель (без функционала)

#### Этап 2: Настройки
- [ ] Модель настроек
- [ ] UI вкладки настроек
- [ ] Сохранение/загрузка настроек
- [ ] Валидация настроек

#### Этап 3: Базовый чат
- [ ] Компонент чата
- [ ] Поле ввода и отправка сообщений
- [ ] Интеграция с LLM API
- [ ] Отображение сообщений
- [ ] Обработка ошибок

#### Этап 4: Расширенный функционал
- [ ] Подключение файлов через @
- [ ] Режимы общения
- [ ] Селектор моделей
- [ ] История чатов

#### Этап 5: Полировка
- [ ] Улучшение UI/UX
- [ ] Оптимизация производительности
- [ ] Тестирование
- [ ] Документация

### 7. Зависимости

**Основные зависимости:**
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^16.11.6",
    "@types/react": "^18.0.33",
    "@types/react-dom": "^18.0.11",
    "esbuild": "^0.25.0",
    "obsidian": "^1.2.5",
    "typescript": "^5.7.2"
  }
}
```

### 8. Примеры использования

**Базовое использование:**
1. Пользователь открывает боковую панель
2. Выбирает режим "Ask"
3. Выбирает модель из списка
4. Вводит вопрос и отправляет
5. Получает ответ от LLM

**С контекстом файлов:**
1. Пользователь вводит `@[[my-note]]` в поле ввода
2. Выбирает файл из автокомплита
3. Файл добавляется в контекст
4. Отправляет сообщение с вопросом о файле
5. LLM получает контекст файла и отвечает

**Загрузка истории:**
1. Пользователь нажимает кнопку истории
2. Видит список предыдущих чатов
3. Выбирает нужный чат
4. История загружается в текущую сессию
5. Может продолжить разговор

### 9. Будущие улучшения

**Возможные расширения:**
- Поддержка изображений в сообщениях
- Голосовой ввод
- Экспорт чатов в различные форматы
- Интеграция с другими инструментами Obsidian
- Поддержка кастомных промптов
- Темы оформления

---

## Примечания

- Спецификация основана на изучении кода `obsidian-copilot`
- Архитектура упрощена для более быстрой разработки
- Фокус на базовом функционале с возможностью расширения
- Все комментарии в коде должны быть на английском языке
- Ответы пользователю на русском языке (если не указано иное)
